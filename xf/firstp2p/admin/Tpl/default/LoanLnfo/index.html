<load href='__TMPL__Common/style/style.css' />
<link href="__ROOT__/static/admin/easyui/themes/default/easyui.css" rel="stylesheet" type="text/css" />
<link href="__ROOT__/static/admin/easyui/themes/icon.css" rel="stylesheet" type="text/css" />
<link href="__ROOT__/static/admin/easyui/demo.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="__ROOT__/static/admin/easyui/jquery_1.10.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/Common/js/script.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/lang.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/easyui/jquery.form.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/easyui/jquery.json-2.3.min.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/easyui/ajaxfileupload.js"></script>
<script type="text/javascript" src="__ROOT__/static/admin/Common/js/loan.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<div class="main">
<div class="main_title">{%ADD} <a href="{:u("PreDeal/index")}" class="back_list">{%BACK_LIST}</a></div>
<div class="blank5"></div>
<form id="companyForm"  method="post" >
    <input type="hidden" name='id' value='{$company.id}' id="company_id" >
    <input type="hidden" name='did' value='{$did}' id='did'>
    <input type="hidden" id='image_count' value='{$image_count}'>
    <div class="blank5"></div>
    <table class="form conf_tab" cellpadding=0 cellspacing=0 rel="1" id="companyTab">
        <tr>
            <td colspan=2 class="topTd"></td>
        </tr>
        
        <tr>
            <td class="item_title">所在企业名称:</td>
            <td class="item_input"><input type="text" class="textbox require" name="name" value="{$company.name}" /></td>
        </tr>
        <tr>
            <td class="item_title">注册地址:</td>
            <td class="item_input"><input type="text" class="textbox " name="address" value="{$company.address}"/></td>
        </tr>
        <tr>
            <td class="item_title">营业执照号:</td>
            <td class="item_input"><input type="text" class="textbox " name="license" value="{$company.license}"  /></td>
        </tr>
         <tr>
            <td class="item_title">项目区域:</td>
            <td class="item_input"><input type="text" class="textbox " name="project_area" value="{$company.project_area}"  /></td>
        </tr>
        <tr>
            <td class="item_title">企业简介:</td>
            <td class="item_input"><textarea  class="textarea" name="description" />{$company.description}</textarea></td>
        </tr>
        <tr>
            <td class="item_title">最高授信额度:</td>
            <td class="item_input"><input type="text" class="textbox " name="top_credit" value="{$company.top_credit}" />元</td>
        </tr>
        
        <tr>
            <td class="item_title">是否地区重点企业:</td>
            <td class="item_input"><input type="text" class="textbox " name="is_important_enterprise" value="{$company.is_important_enterprise}" /></td>
        </tr>
        <tr>
            <td class="item_title">经营情况:</td>
            <td class="item_input"><textarea  class="textarea" name="mangage_condition"  />{$company.mangage_condition}</textarea></td>
        </tr>
        <tr>
            <td class="item_title">涉诉情况:</td>
            <td class="item_input"><input type="text" class="textbox " name="complain_condition"  value="{$company.complain_condition}"/></td>
        </tr>
        
        
        <tr>
            <td class="item_title">征信记录:</td>
            <td class="item_input"><textarea  class="textarea" name="trustworthiness"  />{$company.trustworthiness}</textarea></td>
        </tr>
        <tr>
            <td class="item_title">还款来源:</td>
            <td class="item_input"><textarea  class="textarea" name="source"  />{$company.source}</textarea></td>
        </tr>
        
        <!-- add cl2014-1-6 -->
        <tr>
        	<td class="item_title">企业法人营业执照:</td>
        	<td class="item_input">
        		<input type="hidden"  value="{$company.licence_image}" name='licence_image' id="id_qy" >
                <input id="fileToUpload_qy" type="file" size="5"  name="fileToUpload_qy" onchange="uploadOne(this.id)"><br/>
                <span id="span_qy"><a target="_blank" href="{$company.licence_image_url}">{$company.licence_image_url}</a></span>
                <input type="button" class="textbox" <php> if(empty($company['licence_image_url'])) echo 'style="display:none;"';</php>   id= "del_qy" onclick="del_Image(this.id)" value="删除" />
        	</td>
        </tr>
        
         <tr>
        	<td class="item_title">组织机构代码证:</td>
        	<td class="item_input">
        		<input type="hidden"  value="{$company.organization_iamge}" name='organization_iamge' id="id_zz" >
                <input id="fileToUpload_zz" type="file" size="5"  name="fileToUpload_zz" onchange="uploadOne(this.id)"><br/>
                <span id="span_zz"><a target="_blank" href="{$company.organization_iamge_url}">{$company.organization_iamge_url}</a></span>
                <input type="button" class="textbox" <php> if(empty($company['organization_iamge_url'])) echo 'style="display:none;"';</php>  id= "del_zz" onclick="del_Image(this.id)" value="删除" />
        	</td>
        </tr>
        
         <tr>
        	<td class="item_title">税务登记证:</td>
        	<td class="item_input">
        		<input type="hidden"  value="{$company.taxation_image}" name='taxation_image' id="id_sw" >
                <input id="fileToUpload_sw" type="file" size="5"  name="fileToUpload_sw" onchange="uploadOne(this.id)"><br/>
                <span id="span_sw"><a target="_blank" href="{$company.taxation_image_url}">{$company.taxation_image_url}</a></span>
                <input type="button" class="textbox" <php> if(empty($company['taxation_image_url'])) echo 'style="display:none;"';</php>   id= "del_sw" onclick="del_Image(this.id)" value="删除" />
        	</td>
        </tr>
        
         <tr class ="companyTr">
        	<td class="item_title">银行许可证:</td>
        	<td class="item_input">
        		<input type="hidden"  value="{$company.bank_iamge}" name='bank_iamge' id="id_bk" >
                <input id="fileToUpload_bk" type="file" size="5"  name="fileToUpload_bk" onchange="uploadOne(this.id)"><br/>
                <span id="span_bk"><a target="_blank" href="{$company.bank_iamge_url}">{$company.bank_iamge_url}</a></span>
                <input type="button" class="textbox" <php> if(empty($company['bank_iamge_url'])) echo 'style="display:none;"';</php> id= "del_bk" onclick="del_Image(this.id)" value="删除" />
        	</td>
        </tr>
        <!-- end -->
        <?php 
        	if(!empty($company['image_data'])) {
				foreach($company['image_data'] as $key=>$val) {
					echo '<tr  id="tr_'.$val['image_id'].'" class ="companyTr">
            <td class="item_title">其他图片资料:</td>
            <td class="item_input">
  				<p ><span style="background-color:#b4eeb4;">其他可以展示借款方实力的图片资料，例如其他国家机关颁发的证书、办公环境实际照片等  &nbsp;&nbsp;&nbsp;&nbsp;</span></p>
                                                图片标题<input type="text" name="image_name['.$val['image_id'].']"  value="'.urldecode($val['image_name']).'" id="name_'.$val['image_id'].'" class="textbox">
                <input type="hidden"  value="'.$val['image_id'].'" id="id_'.$val['image_id'].'" class="textbox">
                <input id="fileToUpload_'.$val['image_id'].'" type="file" size="5" name="fileToUpload_'.$val['image_id'].'" onchange="upload(this.id)"><br/>
                <span id="span_'.$val['image_id'].'"><a target="_blank" href="'.get_attr($val['image_id'],1).'">'.get_attr($val['image_id'],1).'</a></span>';

				if(!empty($val['image_id'])) {
					echo ' <input type="button" class="textbox"  id= "d_'.$val['image_id'].'" onclick="del_name(this.id)" value="删除" />';
				}       
					echo '</td> 
        				</tr>';
				}
				echo '<tr><td colspan="2" class="item_input"><input type="button" onclick="addImg()" value="新增一条图片资料"></td></tr>';
			}else{
        ?>
        <tr id="tr_0" class ="companyTr">
            <td class="item_title">其他图片资料:</td>
            <td class="item_input">
            	<p ><span style='background-color:#b4eeb4;'>其他可以展示借款方实力的图片资料，例如其他国家机关颁发的证书、办公环境实际照片等&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
              	 图片标题<input type="text"  value="" id="name_0" name="image_name[]" class="textbox">
                <input type="hidden"  value="" id="id_0" class="textbox">
                <input id="fileToUpload_0" type="file" size="5"  name="fileToUpload_0" onchange="upload(this.id)"><br/>
                <span id="span_0"></span>
                <input type="button" class="textbox" style="display:none;"  id= "d_0" onclick="del_name(this.id)" value="删除" />
            </td>
        </tr>
        <tr>
            <td colspan="2" class="item_input"><input type="button" onclick="addImg()" value="新增一条图片资料"></td>
        </tr>
        <?php }?>
       
         <tr >
            <td class="item_title">市场分析:</td>
            <td class="item_input"><textarea  class="textarea" name="marketplace"  />{$company.marketplace}</textarea></td>
        </tr>
       
         <tr>
            <td class="item_title">政策支持情况:</td>
            <td class="item_input"><textarea  class="textarea" name="policy"  />{$company.policy}</textarea></td>
        </tr>
        
      	<tr>
      		<td class="item_title">所在公司财务状况:</td>
      		<td >
	   			<div style='margin:20px 0px 50px 10px;float:left;'>
				    <table id="tt" ></table>
				</div>
      		</td>
      	</tr>
      
        <tr>
            <td class="item_title"> &nbsp;</td>
            <td><input type='submit' onclick='return check_moile()' value='提交'>
            </td>
        </tr>
    </table>
    
</form>
</div>
<script>
//添加图片
var i = $('#image_count').val(); 
function addImg() {
    i++;
    var str_img = '<tr  id="tr_'+i+'" class ="companyTr">\
                        <td class="item_title">其他图片资料:</td>\
                        <td class="item_input">\
                        	<p ><span style="background-color:#b4eeb4;">其他可以展示借款方实力的图片资料，例如其他国家机关颁发的证书、办公环境实际照片等&nbsp;&nbsp;&nbsp;&nbsp;</span></p>\
                       		 图片标题<input type="text"  value="" name="image_name[]" id="name_'+i+'" class="textbox">\
                            <input type="hidden"  value="" id="id_'+i+'" class="textbox">\
                            <input id="fileToUpload_'+i+'" type="file" size="5" name="fileToUpload_'+i+'" onchange="upload(this.id)"><br/>\
                            <span id="span_'+i+'"></span>\
                            <input type="button" class="textbox" style="display:none;"  id= "d_'+i+'" onclick="del_name(this.id)" value="删除" />\
                        </td>\
                    </tr>';
    $('.companyTr').last().after(str_img); 
    $('#image_count').val(i);               
}


//easyui 插件
$(document).ready(function() { 
	var loanId = $('#company_id').val();
	var did = $('#did').val();
    //ajaxForm
    $('#companyForm').ajaxForm({
        url: '/m.php?m=LoanLnfo&a=saveCompany',
        dataType:'json',
        success: function(data) {
           	if(data.code == '0000') {
           		alert('保存成功!');
               	window.location.href="/m.php?m=LoanLnfo&a=index&id="+loanId+"&did="+did;
              	window.location.reload();
           	}else{
           		alert(data.message);
           	}
        } 
    });  
    var finance_info = $('#company_id').val();
    var tips = finance_info ? '' : '(<font style="color:red;">填写财务情况前，请先提交上述公司信息</font>)'; 
    //datagrid
    $('#tt').datagrid({
        title:'财务情况'+tips,
        iconCls:'icon-edit',
        url:'/m.php?m=LoanLnfo&a=getCompanyFinance&id='+finance_info,
        width:980,
        height:'auto', 
        idField:'id',
        sortName: 'id',
        sortOrder: 'asc',
        remoteSort: true,
        columns:[[ 
                {field:'year',title:'年份',width:90,sortable:true,editor:'text'},
                {field:'master_income',title:'主营业收入(万)',width:120,sortable:true,editor:'text'},
                {field:'gross_profit',title:'毛利润(万)',width:120,sortable:true,editor:'text'},
                {field:'total_assets',title:'总资产(万)',width:120,sortable:true,editor:'text'},
                {field:'net_asset',title:'净资产(万)',width:120,sortable:true,editor:'text'},
                {field:'remarks',title:'备注',width:250,sortable:true,editor:'text'},
                {field:'edit',title:'操作',width:100,align:'center',sortable:false,formatter:function(value,row,index){
                        if(!row.id) {
                            row.id = 99999999;
                        }               
                        //按钮点击操作                
                        if (row.editing){                           
                            var s = '<a href="#tt" onclick="saverow('+index+')">保存</a> ';
                            var c = '<a href="#tt" onclick="cancelrow('+index+')">取消</a>';
                            return s+c;
                        } else {                        
                            var e = '<a href="#tt" onclick="editrow('+index+')">修改</a> ';
                            var d = '<a href="#tt" onclick="deleterow('+index+')">删除</a>';
                            return e+d;
                        }                   
                }}          
        ]],
        onBeforeEdit:function(index,row){
            row.editing = true;
            $('#tt').datagrid('refreshRow', index);
            editcount++;
        },
        onAfterEdit:function(index,row){
            row.editing = false;
            $('#tt').datagrid('refreshRow', index);
            editcount--;
        },
        onCancelEdit:function(index,row){
            row.editing = false;
            $('#tt').datagrid('refreshRow', index);
            editcount--;
        },
        //工具栏
        toolbar:[               
            {
	            text:'增加',
	            iconCls:'icon-add',
	            handler:addrow
        	}
        ]
    }).datagrid('acceptChanges');
}); 
var editcount = 0;  //记录行数
//添加一行
function addrow(){
  if (editcount > 0){
      $.messager.alert('警告','当前还有'+editcount+'记录正在编辑，不能增加记录。');
      return;
  }
  $('#tt').datagrid('appendRow',{
        year:'',
        master_income:'',
        gross_profit:'',
        total_assets:'',
        net_asset:'',
        remarks:''
  });
  var lastIndex = $('#tt').datagrid('getRows').length - 1;
  $('#tt').datagrid('selectRow', lastIndex);
  $('#tt').datagrid('beginEdit', lastIndex);
}

//开始编辑
function editrow(index){    
    $('#tt').datagrid('beginEdit', index);
}
//取消编辑
function cancelrow(index){
    $('#tt').datagrid('cancelEdit', index);
    $('#tt').datagrid('reload');
}

/**
* 编辑表格 提交数据处理
*/
function saverow(index){
    $('#tt').datagrid('endEdit', index);
    _do_au(index,'1');
}

//更新数据
function _do_au(index,type){
    var type = type || '1'; 
    var row  = get_row_by_index(index); 
    if(row ){
        row.loanId = $('#company_id').val();
        if(row.loanId) {
            var saveData = $.toJSON(row);
            $.ajax({
                    type: "POST",
                    url: "/m.php?m=LoanLnfo&a=saveData",           
                    data:{data:saveData,r:Math.random()},  
                    dataType:"json",
                    success: function(msg){
                        if(msg.code == '0000') {
                           $('#tt').datagrid('reload');  
                        }else{
                            alert(msg.message);
                            $('#tt').datagrid('reload');
                        }
                   }
            });
        }else {
            alert('请先添加用户关联信息!');
            $('#tt').datagrid('reload');
        }
    }
}

//获取指定行内的数据
function get_row_by_index(index){
    var obj  = '';
    var rows = $('#tt').datagrid('getRows');
    $.each(rows,function(k,v){
        if($('#tt').datagrid('getRowIndex',v) == index){
            obj = v;
            return false
        }
    })
    return obj;
}
 
//删除
function deleterow(index) {
    var row  = get_row_by_index(index); 
    loanId = $('#company_id').val();
    if(confirm('确认删除?')) {
    	if(row.id && row.loanId) {
    		   $.ajax({
                   type: "POST",
                   url: "/m.php?m=LoanLnfo&a=delCompanyFinance",
                   data: "id="+row.id+"&loanId="+loanId,
                   dataType:"json",
                   success: function(msg){
                        if (msg.code == '0000'){
                            $('#tt').datagrid('deleteRow', index);
                            $('#tt').datagrid('reload');
                        }else{
                            alert(msg.message);
                        }                               
                   }
           });
    	}else{
    		alert('参数id丢失');
    		return false;
    	}
    }
}

</script>

<!-- 插件模块 -->

<include file="Public:footer" />